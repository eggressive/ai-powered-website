name: Security Scanning & Supply Chain Protection

on:
  push:
    branches: [main, master, develop, 'claude/**']
  pull_request:
    branches: [main, master]
  schedule:
    # Run daily at 2 AM UTC to catch new vulnerabilities
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  malware-detection:
    name: Detect Shai-Hulud & Malicious Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scanning

      - name: Check for Shai-Hulud 2.0 Indicators
        run: |
          echo "ðŸ” Scanning for Shai-Hulud 2.0 malware indicators..."

          # Check for known malicious files
          MALICIOUS_FILES=$(find . -type f \( -name "setup_bun.js" -o -name "bun_environment.js" \) 2>/dev/null || true)
          if [ -n "$MALICIOUS_FILES" ]; then
            echo "ðŸš¨ CRITICAL: Malicious files detected!"
            echo "$MALICIOUS_FILES"
            exit 1
          fi

          # Check for suspicious install scripts
          INSTALL_SCRIPTS=$(find . -name "package.json" -not -path "*/node_modules/*" -exec grep -l "\"preinstall\"\|\"postinstall\"" {} \; 2>/dev/null || true)
          if [ -n "$INSTALL_SCRIPTS" ]; then
            echo "âš ï¸  Install scripts found in:"
            echo "$INSTALL_SCRIPTS"
            echo "Reviewing content..."
            for file in $INSTALL_SCRIPTS; do
              echo "=== $file ==="
              grep -A 2 "\"preinstall\"\|\"postinstall\"" "$file" || true
            done
            # Exit with error only if malicious scripts detected
            if grep -r "setup_bun\|bun_environment" $INSTALL_SCRIPTS 2>/dev/null; then
              echo "ðŸš¨ CRITICAL: Malicious install scripts detected!"
              exit 1
            fi
          fi

          # Check for Shai-Hulud string patterns in source code only
          SHAI_STRINGS=$(grep -r "Sha1-Hulud\|Shai-Hulud" . \
            --exclude-dir=node_modules \
            --exclude-dir=.git \
            --exclude-dir=.github \
            --exclude-dir=dist \
            --exclude="*.md" \
            --exclude="*.sh" \
            --exclude=".npmrc" \
            --include="*.js" \
            --include="*.jsx" \
            --include="*.ts" \
            --include="*.tsx" \
            --include="*.py" \
            2>/dev/null || true)
          if [ -n "$SHAI_STRINGS" ]; then
            echo "ðŸš¨ CRITICAL: Shai-Hulud signature strings found in source code!"
            echo "$SHAI_STRINGS"
            exit 1
          fi

          echo "âœ… No immediate malware indicators detected"

      - name: Check for Suspicious GitHub Workflows
        run: |
          echo "ðŸ” Checking GitHub workflows for suspicious patterns..."
          if [ -d ".github/workflows" ]; then
            # Check for workflows with suspicious names (Shai-Hulud persistence mechanism)
            if ls .github/workflows/discussion.yaml 2>/dev/null || ls .github/workflows/discussion.yml 2>/dev/null; then
              echo "ðŸš¨ CRITICAL: Suspicious workflow file 'discussion.yaml/yml' detected!"
              exit 1
            fi
          fi
          echo "âœ… No suspicious workflows detected"

  dependency-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Install dependencies safely
        run: |
          cd ai-intent-tracker
          # Install with frozen lockfile and ignore scripts
          pnpm install --frozen-lockfile --ignore-scripts
        env:
          NODE_ENV: development

      - name: Run pnpm audit
        continue-on-error: true  # Don't fail the build on vulnerabilities, just report
        run: |
          cd ai-intent-tracker
          echo "ðŸ” Running pnpm security audit..."
          pnpm audit --audit-level=moderate || {
            echo "âš ï¸  Vulnerabilities detected - review required"
            exit 0  # Don't fail, just warn
          }

      - name: Generate audit report
        continue-on-error: true
        run: |
          cd ai-intent-tracker
          pnpm audit --json > ../audit-report.json || true
          echo "Audit report generated"

      - name: Check for known vulnerable packages
        run: |
          cd ai-intent-tracker
          echo "ðŸ” Checking for known compromised packages..."

          # List of some known compromised packages (update regularly)
          # This is a sample - refer to npm advisories for complete list
          KNOWN_BAD_PACKAGES="@posthog/plugin-scaffold@1.4.4 posthog@3.8.0"

          for pkg in $KNOWN_BAD_PACKAGES; do
            if pnpm list "$pkg" 2>/dev/null | grep -q "$pkg"; then
              echo "ðŸš¨ CRITICAL: Known compromised package detected: $pkg"
              exit 1
            fi
          done

          echo "âœ… No known compromised packages detected"

      - name: Verify lock file integrity
        run: |
          cd ai-intent-tracker
          echo "ðŸ” Verifying lock file integrity..."

          # Check if lock file has been tampered with
          if git diff --exit-code pnpm-lock.yaml; then
            echo "âœ… Lock file integrity verified"
          else
            echo "âš ï¸  Lock file has uncommitted changes!"
            git diff pnpm-lock.yaml || true
          fi

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-audit-report
          path: audit-report.json
          retention-days: 30

  secret-scanning:
    name: Secret & Credential Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for exposed credentials in code
        run: |
          echo "ðŸ” Checking for exposed credentials..."

          # Check for npm tokens
          if grep -r "npm_[A-Za-z0-9_]\{36\}" . --exclude-dir=node_modules --exclude-dir=.git 2>/dev/null; then
            echo "ðŸš¨ CRITICAL: npm token pattern detected in code!"
            exit 1
          fi

          # Check for GitHub PATs
          if grep -r "ghp_[A-Za-z0-9_]\{36\}" . --exclude-dir=node_modules --exclude-dir=.git 2>/dev/null; then
            echo "ðŸš¨ CRITICAL: GitHub token pattern detected in code!"
            exit 1
          fi

          # Check for AWS keys
          if grep -r "AKIA[0-9A-Z]\{16\}" . --exclude-dir=node_modules --exclude-dir=.git 2>/dev/null; then
            echo "ðŸš¨ CRITICAL: AWS access key pattern detected in code!"
            exit 1
          fi

          echo "âœ… No exposed credentials detected"

  supply-chain-analysis:
    name: Supply Chain Security Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Install dependencies for SBOM
        run: |
          cd ai-intent-tracker
          pnpm install --frozen-lockfile --ignore-scripts

      - name: Generate SBOM (Software Bill of Materials)
        continue-on-error: true  # Don't fail if SBOM generation fails
        run: |
          cd ai-intent-tracker
          echo "ðŸ“¦ Generating Software Bill of Materials..."
          npx @cyclonedx/cyclonedx-npm@latest --output-file ../sbom.json || {
            echo "âš ï¸  SBOM generation failed - continuing anyway"
            echo "{}" > ../sbom.json
          }

          if [ -f ../sbom.json ]; then
            echo "âœ… SBOM generated successfully"
          fi

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: software-bill-of-materials
          path: sbom.json
          retention-days: 90

      - name: Analyze dependency tree depth
        continue-on-error: true
        run: |
          cd ai-intent-tracker
          echo "ðŸŒ³ Analyzing dependency tree..."

          # Count total dependencies
          DIRECT=$(pnpm list --depth=0 --json 2>/dev/null | grep -c "dependencies" || echo "0")
          echo "Direct dependencies: $DIRECT"

          echo "âœ… Dependency analysis complete"

  python-security:
    name: Python Dependency Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Safety
        run: |
          pip install safety

      - name: Scan Python dependencies
        continue-on-error: true  # Don't fail on vulnerabilities, just report
        run: |
          cd ai_intent_backend
          echo "ðŸ” Scanning Python dependencies for vulnerabilities..."
          safety check -r requirements.txt --json > ../python-security-report.json || {
            echo "âš ï¸  Vulnerabilities found - review required"
            echo "{}" > ../python-security-report.json
          }
          safety check -r requirements.txt || echo "âš ï¸  Vulnerabilities detected"

      - name: Check for suspicious Python packages
        run: |
          cd ai_intent_backend
          echo "ðŸ” Checking for suspicious Python packages..."

          # Check for packages with suspicious names (typosquatting)
          SUSPICIOUS=$(grep -E "reqeusts|pillow|numpy|scipy|pandas" requirements.txt 2>/dev/null || true)
          if [ -n "$SUSPICIOUS" ]; then
            echo "âš ï¸  Package names found (verify they are correct):"
            echo "$SUSPICIOUS"
          fi

          echo "âœ… Python package check complete"

      - name: Upload Python security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: python-security-report
          path: python-security-report.json
          retention-days: 30

  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [malware-detection, dependency-audit, secret-scanning, supply-chain-analysis, python-security]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Jobs Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Malware Detection: ${{ needs.malware-detection.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Audit: ${{ needs.dependency-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Secret Scanning: ${{ needs.secret-scanning.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Supply Chain Analysis: ${{ needs.supply-chain-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Python Security: ${{ needs.python-security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Review all security reports in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Update vulnerable dependencies promptly" >> $GITHUB_STEP_SUMMARY
          echo "- Rotate credentials if any leaks detected" >> $GITHUB_STEP_SUMMARY
          echo "- Review and approve Dependabot PRs weekly" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Quick Actions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Run local compromise check" >> $GITHUB_STEP_SUMMARY
          echo "./check-shai-hulud.sh" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Update dependencies" >> $GITHUB_STEP_SUMMARY
          echo "cd ai-intent-tracker && pnpm audit fix" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
