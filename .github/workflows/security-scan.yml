name: Security Scanning & Supply Chain Protection

on:
  push:
    branches: [main, master, develop, 'claude/**']
  pull_request:
    branches: [main, master]
  schedule:
    # Run daily at 2 AM UTC to catch new vulnerabilities
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  malware-detection:
    name: Detect Shai-Hulud & Malicious Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history for comprehensive scanning

      - name: Check for Shai-Hulud 2.0 Indicators
        run: |
          echo "ðŸ” Scanning for Shai-Hulud 2.0 malware indicators..."

          # Check for known malicious files
          MALICIOUS_FILES=$(find . -type f \( -name "setup_bun.js" -o -name "bun_environment.js" \) 2>/dev/null || true)
          if [ -n "$MALICIOUS_FILES" ]; then
            echo "ðŸš¨ CRITICAL: Malicious files detected!"
            echo "$MALICIOUS_FILES"
            exit 1
          fi

          # Check for suspicious install scripts
          INSTALL_SCRIPTS=$(find . -name "package.json" -not -path "*/node_modules/*" -exec grep -l "\"preinstall\"\|\"postinstall\"" {} \; 2>/dev/null || true)
          if [ -n "$INSTALL_SCRIPTS" ]; then
            echo "âš ï¸  Install scripts found in:"
            echo "$INSTALL_SCRIPTS"
            echo "Reviewing content..."
            for file in $INSTALL_SCRIPTS; do
              echo "=== $file ==="
              grep -A 2 "\"preinstall\"\|\"postinstall\"" "$file" || true
            done
            # Exit with error only if malicious scripts detected
            if grep -r "setup_bun\|bun_environment" $INSTALL_SCRIPTS 2>/dev/null; then
              echo "ðŸš¨ CRITICAL: Malicious install scripts detected!"
              exit 1
            fi
          fi

          # Check for Shai-Hulud string patterns in source code only
          SHAI_STRINGS=$(grep -r "Shai-Hulud\|Sha1-Hulud" . \
            --exclude-dir=node_modules \
            --exclude-dir=.git \
            --exclude-dir=.github \
            --exclude-dir=dist \
            --exclude="*.md" \
            --exclude="*.sh" \
            --exclude=".npmrc" \
            --include="*.js" \
            --include="*.jsx" \
            --include="*.ts" \
            --include="*.tsx" \
            --include="*.py" \
            2>/dev/null || true)
          if [ -n "$SHAI_STRINGS" ]; then
            echo "ðŸš¨ CRITICAL: Shai-Hulud signature strings found in source code!"
            echo "$SHAI_STRINGS"
            exit 1
          fi

          echo "âœ… No immediate malware indicators detected"

      - name: Check for Suspicious GitHub Workflows
        run: |
          echo "ðŸ” Checking GitHub workflows for suspicious patterns..."
          if [ -d ".github/workflows" ]; then
            # Check for workflows with suspicious names (Shai-Hulud persistence mechanism)
            if ls .github/workflows/discussion.yaml 2>/dev/null || ls .github/workflows/discussion.yml 2>/dev/null; then
              echo "ðŸš¨ CRITICAL: Suspicious workflow file 'discussion.yaml/yml' detected!"
              exit 1
            fi
          fi
          echo "âœ… No suspicious workflows detected"

  dependency-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies safely
        run: |
          cd ai-intent-tracker
          # Install with frozen lockfile and ignore scripts
          pnpm install --frozen-lockfile --ignore-scripts
        env:
          NODE_ENV: development

      - name: Run pnpm audit
        continue-on-error: true  # Don't fail the build on vulnerabilities, just report
        run: |
          cd ai-intent-tracker
          echo "ðŸ” Running pnpm security audit..."
          pnpm audit --audit-level=moderate || {
            echo "âš ï¸  Vulnerabilities detected - review required"
            exit 0  # Don't fail, just warn
          }

      - name: Generate audit report
        continue-on-error: true
        run: |
          cd ai-intent-tracker
          pnpm audit --json > ../audit-report.json || true
          echo "Audit report generated"

      - name: Check for known vulnerable packages
        run: |
          cd ai-intent-tracker
          echo "ðŸ” Checking for critical vulnerabilities in dependencies..."

          # Parse pnpm audit output for critical and high severity issues
          # This uses the npm advisory database which is continuously updated
          AUDIT_OUTPUT=$(pnpm audit --json 2>/dev/null || echo '{}')

          # Check for critical vulnerabilities
          CRITICAL_COUNT=$(echo "$AUDIT_OUTPUT" | grep -o '"critical":[0-9]*' | grep -o '[0-9]*' || echo "0")
          HIGH_COUNT=$(echo "$AUDIT_OUTPUT" | grep -o '"high":[0-9]*' | grep -o '[0-9]*' || echo "0")

          if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 0 ]; then
            echo "ðŸš¨ CRITICAL/HIGH severity vulnerabilities detected!"
            echo "   Critical: $CRITICAL_COUNT"
            echo "   High: $HIGH_COUNT"
            echo ""
            echo "Run 'pnpm audit' locally for details"
            pnpm audit --audit-level=high || true
            exit 1
          fi

          # Optional: Check for specific blocklisted packages
          # Add packages here that should never be installed, even if not flagged by audit
          # Format: "package-name@version" or just "package-name"
          # Update this list based on security advisories from:
          # - https://github.com/advisories
          # - https://security.snyk.io/
          # - Your organization's security team
          BLOCKLIST=""
          # Example: BLOCKLIST="malicious-package@1.0.0 another-bad-pkg"

          if [ -n "$BLOCKLIST" ]; then
            echo "Checking blocklist..."
            for pkg in $BLOCKLIST; do
              if pnpm list "$pkg" 2>/dev/null | grep -q "$pkg"; then
                echo "ðŸš¨ BLOCKED: Package on blocklist detected: $pkg"
                exit 1
              fi
            done
          fi

          echo "âœ… No critical/high vulnerabilities or blocklisted packages detected"

      - name: Verify lock file integrity
        run: |
          cd ai-intent-tracker
          echo "ðŸ” Verifying lock file integrity..."

          # Check if lock file has been tampered with
          if git diff --exit-code pnpm-lock.yaml; then
            echo "âœ… Lock file integrity verified"
          else
            echo "âš ï¸  Lock file has uncommitted changes!"
            git diff pnpm-lock.yaml || true
          fi

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-audit-report
          path: audit-report.json
          retention-days: 30

  secret-scanning:
    name: Secret & Credential Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check for exposed credentials in code
        run: |
          echo "ðŸ” Checking for exposed credentials..."

          # Check for npm tokens
          if grep -r "npm_[A-Za-z0-9_]\{36\}" . --exclude-dir=node_modules --exclude-dir=.git 2>/dev/null; then
            echo "ðŸš¨ CRITICAL: npm token pattern detected in code!"
            exit 1
          fi

          # Check for GitHub PATs
          if grep -r "ghp_[A-Za-z0-9_]\{36\}" . --exclude-dir=node_modules --exclude-dir=.git 2>/dev/null; then
            echo "ðŸš¨ CRITICAL: GitHub token pattern detected in code!"
            exit 1
          fi

          # Check for AWS keys
          if grep -r "AKIA[0-9A-Z]\{16\}" . --exclude-dir=node_modules --exclude-dir=.git 2>/dev/null; then
            echo "ðŸš¨ CRITICAL: AWS access key pattern detected in code!"
            exit 1
          fi

          echo "âœ… No exposed credentials detected"

  supply-chain-analysis:
    name: Supply Chain Security Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies for SBOM
        run: |
          cd ai-intent-tracker
          pnpm install --frozen-lockfile --ignore-scripts

      - name: Generate SBOM (Software Bill of Materials)
        continue-on-error: true  # Don't fail if SBOM generation fails
        run: |
          cd ai-intent-tracker
          echo "ðŸ“¦ Generating Software Bill of Materials..."
          npx @cyclonedx/cyclonedx-npm@latest --output-file ../sbom.json || {
            echo "âš ï¸  SBOM generation failed - continuing anyway"
            echo "{}" > ../sbom.json
          }

          if [ -f ../sbom.json ]; then
            echo "âœ… SBOM generated successfully"
          fi

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: software-bill-of-materials
          path: sbom.json
          retention-days: 90

      - name: Analyze dependency tree depth
        continue-on-error: true
        run: |
          cd ai-intent-tracker
          echo "ðŸŒ³ Analyzing dependency tree..."

          # Count total dependencies
          DIRECT=$(pnpm list --depth=0 --json 2>/dev/null | grep -c "dependencies" || echo "0")
          echo "Direct dependencies: $DIRECT"

          echo "âœ… Dependency analysis complete"

  python-security:
    name: Python Dependency Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install Safety
        run: |
          pip install safety

      - name: Scan Python dependencies
        continue-on-error: true  # Don't fail on vulnerabilities, just report
        run: |
          cd ai_intent_backend
          echo "ðŸ” Scanning Python dependencies for vulnerabilities..."
          safety check -r requirements.txt --json > ../python-security-report.json || {
            echo "âš ï¸  Vulnerabilities found - review required"
            echo "{}" > ../python-security-report.json
          }
          safety check -r requirements.txt || echo "âš ï¸  Vulnerabilities detected"

      - name: Check for suspicious Python packages
        run: |
          cd ai_intent_backend
          echo "ðŸ” Checking for typosquatted Python packages..."

          # Check for common typosquatting patterns
          # These are MISSPELLINGS of legitimate packages that attackers use
          TYPOS_FOUND=false

          # Check for "requests" typos (correct: requests)
          if grep -qE "^(reqeusts|requestes|reques|request)==" requirements.txt 2>/dev/null; then
            echo "ðŸš¨ Possible typo of 'requests' package found"
            grep -E "^(reqeusts|requestes|reques|request)==" requirements.txt
            TYPOS_FOUND=true
          fi

          # Check for "urllib3" typos (correct: urllib3)
          if grep -qE "^(urlib3|urlib|urllib)==" requirements.txt 2>/dev/null; then
            echo "ðŸš¨ Possible typo of 'urllib3' package found"
            grep -E "^(urlib3|urlib|urllib)==" requirements.txt
            TYPOS_FOUND=true
          fi

          # Check for "setuptools" typos (correct: setuptools)
          if grep -qE "^(setuptool|setup-tools)==" requirements.txt 2>/dev/null; then
            echo "ðŸš¨ Possible typo of 'setuptools' package found"
            grep -E "^(setuptool|setup-tools)==" requirements.txt
            TYPOS_FOUND=true
          fi

          # Check for "numpy" typos (correct: numpy)
          if grep -qE "^(numbpy|nunpy|numpi|numpby)==" requirements.txt 2>/dev/null; then
            echo "ðŸš¨ Possible typo of 'numpy' package found"
            grep -E "^(numbpy|nunpy|numpi|numpby)==" requirements.txt
            TYPOS_FOUND=true
          fi

          # Check for "beautifulsoup4" typos (correct: beautifulsoup4)
          if grep -qE "^(beautifulsoup|beautiful-soup)==" requirements.txt 2>/dev/null; then
            echo "ðŸš¨ Possible typo of 'beautifulsoup4' package found"
            grep -E "^(beautifulsoup|beautiful-soup)==" requirements.txt
            TYPOS_FOUND=true
          fi

          # Check for single-char package names (usually malicious)
          if grep -qE "^[a-zA-Z]==" requirements.txt 2>/dev/null; then
            echo "ðŸš¨ Suspicious single-character package found"
            grep -E "^[a-zA-Z]==" requirements.txt
            TYPOS_FOUND=true
          fi

          if [ "$TYPOS_FOUND" = true ]; then
            echo ""
            echo "Common legitimate packages for reference:"
            echo "  âœ… requests      (not: reqeusts, requestes, request)"
            echo "  âœ… urllib3       (not: urlib3, urlib, urllib)"
            echo "  âœ… setuptools    (not: setuptool, setup-tools)"
            echo "  âœ… numpy         (not: numbpy, nunpy, numpi)"
            echo "  âœ… beautifulsoup4 (not: beautifulsoup)"
            exit 1
          fi

          echo "âœ… No typosquatted packages detected"

      - name: Upload Python security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: python-security-report
          path: python-security-report.json
          retention-days: 30

  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [malware-detection, dependency-audit, secret-scanning, supply-chain-analysis, python-security]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Jobs Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Malware Detection: ${{ needs.malware-detection.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Audit: ${{ needs.dependency-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Secret Scanning: ${{ needs.secret-scanning.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Supply Chain Analysis: ${{ needs.supply-chain-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Python Security: ${{ needs.python-security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Review all security reports in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Update vulnerable dependencies promptly" >> $GITHUB_STEP_SUMMARY
          echo "- Rotate credentials if any leaks detected" >> $GITHUB_STEP_SUMMARY
          echo "- Review and approve Dependabot PRs weekly" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Quick Actions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Run local compromise check" >> $GITHUB_STEP_SUMMARY
          echo "./scripts/check-shai-hulud.sh" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Update dependencies" >> $GITHUB_STEP_SUMMARY
          echo "cd ai-intent-tracker && pnpm audit fix" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
